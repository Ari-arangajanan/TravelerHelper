package com.MITProjectAdmin.configs;import com.MITProjectAdmin.security.AuthorizationService;import com.MITProjectAdmin.security.RefreshTokenService;import com.MITProjectAdmin.security.TokenBlacklistService;import com.MITProjectAdmin.security.impl.UserServiceImpl;import com.MITProjectService.admin.domain.system.RefreshToken;import com.MITProjectService.exceptionhandling.TokenRefreshException;import com.MITProjectService.framework.redis.RedisCashService;import jakarta.servlet.FilterChain;import jakarta.servlet.ServletException;import jakarta.servlet.http.Cookie;import jakarta.servlet.http.HttpServletRequest;import jakarta.servlet.http.HttpServletResponse;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.beans.factory.annotation.Value;import org.springframework.http.HttpStatus;import org.springframework.security.authentication.BadCredentialsException;import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;import org.springframework.security.core.context.SecurityContextHolder;import org.springframework.security.core.userdetails.UserDetails;import org.springframework.security.core.userdetails.UsernameNotFoundException;import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;import org.springframework.stereotype.Component;import org.springframework.web.filter.OncePerRequestFilter;import java.io.IOException;import java.time.Instant;import java.util.Date;@Componentpublic class JwtAuthFilter extends OncePerRequestFilter {    @Value("${admin.jwtExpirationMs}")    private long MINUTES;    @Autowired    private JwtHelper jwtHelper;    @Autowired    private UserServiceImpl userServiceImpl;    @Autowired    private RefreshTokenService refreshTokenService;    @Autowired    private RedisCashService redisCashService;    @Autowired    private TokenBlacklistService tokenBlacklistService;    @Override    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException, UsernameNotFoundException {        String authHeader = request.getHeader("Authorization");        String userName = null;        String token = null;        if ("/admin/systemUser/login".equals(request.getRequestURI())) {            filterChain.doFilter(request, response);            return;        }//        if ("/admin/systemUser/register".equals(request.getRequestURI())) {//            filterChain.doFilter(request, response);//            return;//        }        if (request.getCookies() != null) {            for (Cookie cookie : request.getCookies()) {                if (cookie.getName().equals("refreshToken")) {                    String refreshToken = cookie.getValue();                    String[] splitTxt = refreshToken.split(":");                    RefreshToken cashedRefreshToken = redisCashService.getRefreshToken("RefreshToken:" + refreshToken);                    if (cashedRefreshToken != null && cashedRefreshToken.getExpiryDate().isAfter(Instant.now())) {                        String username = jwtHelper.getUserName(splitTxt[1]);                        token = redisCashService.getAccessToken("accessToken:" + refreshToken);                        if (token == null || token.isEmpty()) {                            token = jwtHelper.GenerateToken(splitTxt[0]);                            redisCashService.saveValInMin("accessToken:" + username + ":", token, MINUTES);                        }                    }else response.sendError(HttpServletResponse.SC_UNAUTHORIZED, "Refresh token expired. Please log in again.");                    if (token != null) userName = jwtHelper.getUserName(token);                    break;                } else {                    // Refresh token is invalid or expired, clear the cookie                    Cookie expiredCookie = new Cookie("refreshToken", null);                    expiredCookie.setHttpOnly(true);                    expiredCookie.setPath("/");                    expiredCookie.setMaxAge(0);                    response.addCookie(expiredCookie);                    // Return 401 response instead of 403                    response.sendError(HttpServletResponse.SC_UNAUTHORIZED, "Unauthorized. Please log in again.");                    return;                }            }        }//        if (authHeader != null && authHeader.startsWith("token ")) {//            token = authHeader.substring(6);//            userName = jwtHelper.getUserName(token);//        }        if (userName != null && SecurityContextHolder.getContext().getAuthentication() == null) {            UserDetails userDetails = userServiceImpl.loadUserByUsername(userName);            if (userDetails == null) throw new BadCredentialsException("userAccount not found");            if (jwtHelper.validateToken(token, userDetails)) {                UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(                        userDetails, null, userDetails.getAuthorities()                );                authenticationToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));                SecurityContextHolder.getContext().setAuthentication(authenticationToken);            }else {                response.sendError(HttpServletResponse.SC_UNAUTHORIZED);                return;            }        }        if (token != null && tokenBlacklistService.isBlacklisted(token)) {            response.sendError(HttpStatus.UNAUTHORIZED.value(), "Token expired or invalid");            return;        }        filterChain.doFilter(request, response);    }}